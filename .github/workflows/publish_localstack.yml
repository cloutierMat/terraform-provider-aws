# Terraform Provider release workflow.
name: Release

on:
    # push:
    #     tags:
    #         - "v*"
    workflow_dispatch:
        inputs:
            goReleaserKey:
                description: 'go releaser key'
                required: true
                type: string



permissions:
    contents: write
    id-token: write
    packages: write

jobs:
    prepare:
        strategy:
            matrix:
                GOOS: [linux, windows, darwin, freebsd]
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
            with:
                # Allow goreleaser to access older tag information.
                fetch-depth: 0
          - name: Setup Go
            uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5.0.0
            with:
                go-version-file: "go.mod"
                cache: true
          - shell: bash
            run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          - name: OS Release Cache
            id: cache
            uses: actions/cache@v3
            with:
                path: dist/${{ matrix.GOOS }}
                key: ${{ matrix.GOOS }}-${{ env.sha_short }}
          - name: Prepare dist/${{ matrix.GOOS }}
            uses: goreleaser/goreleaser-action@f82d6c1c344bcacabba2c841718984797f664a6b # v4.2.0
            if: steps.cache.outputs.cache-hit != 'true'
            with:
                distribution: goreleaser-pro
                version: latest
                args: release --clean --split --timeout 1h
            env:
                GGOOS: ${{ matrix.GOOS }}
                GITHUB_TOKEN: ${{ secrets.GH_PAT }}
                GORELEASER_KEY: ${{ inputs.goReleaserKey }}
    release:
        runs-on: ubuntu-latest
        needs: prepare
        steps:
          - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
            with:
                fetch-depth: 0
          - uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5.0.0
            with:
                go-version-file: "go.mod"
                cache: true

            # copy the cashes from prepare
          - shell: bash
            run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          - uses: actions/cache@v3
            with:
                path: dist/linux
                key: linux-${{ env.sha_short }}
          - uses: actions/cache@v3
            with:
                path: dist/darwin
                key: darwin-${{ env.sha_short }}
          - uses: actions/cache@v3
            with:
                path: dist/windows
                key: windows-${{ env.sha_short }}
          - uses: actions/cache@v3
            with:
                path: dist/freebsd
                key: freebsd-${{ env.sha_short }}


            # release
          - uses: goreleaser/goreleaser-action@f82d6c1c344bcacabba2c841718984797f664a6b # v4.2.0
            with:
                distribution: goreleaser-pro
                version: latest
                args: continue --merge --timeout 1h
            env:
                GITHUB_TOKEN: ${{ secrets.GH_PAT }}
                GORELEASER_KEY: ${{ inputs.goReleaserKey }}

            # - name: Set up Python 3.10.5
            # uses: actions/setup-python@v4
            # with:
            #     python-version: '3.10.5'
            #     cache: 'pip'

            # - name: Install system dependencies
            # run: |
            #     python -m venv .venv
            #     source .venv/bin/activate
            #     pip install --upgrade pip
            #     pip install -r requirements.txt

            # - name: Extract
            # run: |
            #     source .venv/bin/activate
            #     python -m terraform_pytest.main patch

            # - name: Apply Terraform Plugin Sdk Patch
            #     run: |
            #         cd terraform-provider-aws
            #         sdk_version=$(go list -m github.com/hashicorp/terraform-plugin-sdk/v2 | sed -n -e 's/^.* //p')
            #         go mod edit --replace github.com/hashicorp/terraform-plugin-sdk/v2=github.com/cloutierMat/terraform-plugin-sdk/v2@${sdk_version}-001
            #         go mod tidy
